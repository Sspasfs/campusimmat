<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CampusImmat: Azure Active Directory Provider for OAuth 2.0 Client</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CampusImmat
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Généré par Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Recherche');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Chargement...</div>
<div class="SRStatus" id="Searching">Recherche...</div>
<div class="SRStatus" id="NoMatches">Aucune correspondance</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Azure Active Directory Provider for OAuth 2.0 Client</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md7423"></a><a href="https://github.com/thenetworg/oauth2-azure/releases"><img src="https://img.shields.io/github/release/thenetworg/oauth2-azure.svg?style=flat-square" alt="Latest Version" style="pointer-events: none;" class="inline"/></a> <a href="https://packagist.org/packages/thenetworg/oauth2-azure"><img src="https://img.shields.io/packagist/dt/thenetworg/oauth2-azure.svg?style=flat-square" alt="Total Downloads" style="pointer-events: none;" class="inline"/></a> <a class="el" href="md_public_2glpi_2vendor_2thenetworg_2oauth2-azure_2_l_i_c_e_n_s_e.html"><img src="https://img.shields.io/packagist/l/thenetworg/oauth2-azure.svg?style=flat-square" alt="Software License" style="pointer-events: none;" class="inline"/></a></p>
<p>This package provides <a href="https://azure.microsoft.com/en-us/services/active-directory/">Azure Active Directory</a> OAuth 2.0 support for the PHP League's <a href="https://github.com/thephpleague/oauth2-client">OAuth 2.0 Client</a>.</p>
<h1><a class="anchor" id="autotoc_md7424"></a>
Table of Contents</h1>
<ul>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Installation</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Usage</a><ul>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Authorization Code Flow</a><ul>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Advanced flow</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Using custom parameters</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">**NEW** - Call on behalf of a token provided by another app</a></li>
</ul>
</li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">**NEW** - Logging out</a></li>
</ul>
</li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Making API Requests</a><ul>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Variables</a></li>
</ul>
</li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Resource Owner</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">**UPDATED** - Microsoft Graph</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">**NEW** - Protecting your API - *experimental*</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Azure Active Directory B2C - *experimental*</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Multipurpose refresh tokens - *experimental*</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Known users</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Contributing</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Credits</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">Support</a></li>
<li><a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">License</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md7425"></a>
Installation</h1>
<p>To install, use composer:</p>
<div class="fragment"><div class="line">composer require thenetworg/oauth2-azure</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7426"></a>
Usage</h1>
<p>Usage is the same as The League's OAuth client, using <code>\TheNetworg\OAuth2\Client\Provider\Azure</code> as the provider.</p>
<h2><a class="anchor" id="autotoc_md7427"></a>
Authorization Code Flow</h2>
<div class="fragment"><div class="line">$provider = <span class="keyword">new</span> <a class="code hl_class" href="class_the_networg_1_1_o_auth2_1_1_client_1_1_provider_1_1_azure.html">TheNetworg\OAuth2\Client\Provider\Azure</a>([</div>
<div class="line">    <span class="stringliteral">&#39;clientId&#39;</span>          =&gt; <span class="stringliteral">&#39;{azure-client-id}&#39;</span>,</div>
<div class="line">    <span class="stringliteral">&#39;clientSecret&#39;</span>      =&gt; <span class="stringliteral">&#39;{azure-client-secret}&#39;</span>,</div>
<div class="line">    <span class="stringliteral">&#39;redirectUri&#39;</span>       =&gt; <span class="stringliteral">&#39;https://example.com/callback-url&#39;</span>,</div>
<div class="line">    <span class="comment">//Optional</span></div>
<div class="line">    <span class="stringliteral">&#39;scopes&#39;</span>            =&gt; [<span class="stringliteral">&#39;openid&#39;</span>],</div>
<div class="line">    <span class="comment">//Optional</span></div>
<div class="line">    <span class="stringliteral">&#39;defaultEndPointVersion&#39;</span> =&gt; <span class="stringliteral">&#39;2.0&#39;</span></div>
<div class="line">]);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set to use v2 API, skip the line or set the value to Azure::ENDPOINT_VERSION_1_0 if willing to use v1 API</span></div>
<div class="line">$provider-&gt;defaultEndPointVersion = TheNetworg\OAuth2\Client\Provider\Azure::ENDPOINT_VERSION_2_0;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$baseGraphUri</a> = $provider-&gt;getRootMicrosoftGraphUri(<span class="keyword">null</span>);</div>
<div class="line">$provider-&gt;scope = <span class="stringliteral">&#39;openid profile email offline_access &#39;</span> . <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$baseGraphUri</a> . <span class="stringliteral">&#39;/User.Read&#39;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">isset</a>(<a class="code hl_variable" href="common_8tabs_8php.html#a7b2772071c2b50e11742306f5abe68e3">$_GET</a>[<span class="stringliteral">&#39;code&#39;</span>]) &amp;&amp; <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">isset</a>(<a class="code hl_variable" href="ajax_2knowbase_8php.html#a8d51972dab0856e7ed5db52b906de613">$_SESSION</a>[<span class="stringliteral">&#39;OAuth2.state&#39;</span>]) &amp;&amp; <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">isset</a>(<a class="code hl_variable" href="common_8tabs_8php.html#a7b2772071c2b50e11742306f5abe68e3">$_GET</a>[<span class="stringliteral">&#39;state&#39;</span>])) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="common_8tabs_8php.html#a7b2772071c2b50e11742306f5abe68e3">$_GET</a>[<span class="stringliteral">&#39;state&#39;</span>] == <a class="code hl_variable" href="ajax_2knowbase_8php.html#a8d51972dab0856e7ed5db52b906de613">$_SESSION</a>[<span class="stringliteral">&#39;OAuth2.state&#39;</span>]) {</div>
<div class="line">        unset(<a class="code hl_variable" href="ajax_2knowbase_8php.html#a8d51972dab0856e7ed5db52b906de613">$_SESSION</a>[<span class="stringliteral">&#39;OAuth2.state&#39;</span>]);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Try to get an access token (using the authorization code grant)</span></div>
<div class="line">        $token = $provider-&gt;getAccessToken(<span class="stringliteral">&#39;authorization_code&#39;</span>, [</div>
<div class="line">            <span class="stringliteral">&#39;scope&#39;</span> =&gt; $provider-&gt;scope,</div>
<div class="line">            <span class="stringliteral">&#39;code&#39;</span> =&gt; <a class="code hl_variable" href="common_8tabs_8php.html#a7b2772071c2b50e11742306f5abe68e3">$_GET</a>[<span class="stringliteral">&#39;code&#39;</span>],</div>
<div class="line">        ]);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Verify token</span></div>
<div class="line">        <span class="comment">// Save it to local server session data</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> $token-&gt;getToken();</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">echo</a> <span class="stringliteral">&#39;Invalid state&#39;</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line">    }</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// // Check local server&#39;s session data for a token</span></div>
<div class="line">    <span class="comment">// // and verify if still valid </span></div>
<div class="line">    <span class="comment">// /** @var ?AccessToken $token */</span></div>
<div class="line">    <span class="comment">// $token = // token cached in session data, null if not found;</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// if (isset($token)) {</span></div>
<div class="line">    <span class="comment">//    $me = $provider-&gt;get($provider-&gt;getRootMicrosoftGraphUri($token) . &#39;/v1.0/me&#39;, $token);</span></div>
<div class="line">    <span class="comment">//    $userEmail = $me[&#39;mail&#39;];</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">//    if ($token-&gt;hasExpired()) {</span></div>
<div class="line">    <span class="comment">//        if (!is_null($token-&gt;getRefreshToken())) {</span></div>
<div class="line">    <span class="comment">//            $token = $provider-&gt;getAccessToken(&#39;refresh_token&#39;, [</span></div>
<div class="line">    <span class="comment">//                &#39;scope&#39; =&gt; $provider-&gt;scope,</span></div>
<div class="line">    <span class="comment">//                &#39;refresh_token&#39; =&gt; $token-&gt;getRefreshToken()</span></div>
<div class="line">    <span class="comment">//            ]);</span></div>
<div class="line">    <span class="comment">//        } else {</span></div>
<div class="line">    <span class="comment">//            $token = null;</span></div>
<div class="line">    <span class="comment">//        }</span></div>
<div class="line">    <span class="comment">//    }</span></div>
<div class="line">    <span class="comment">//}</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// If the token is not found in </span></div>
<div class="line">    <span class="comment">// if (!isset($token)) {</span></div>
<div class="line">        <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$authorizationUrl</a> = $provider-&gt;getAuthorizationUrl([<span class="stringliteral">&#39;scope&#39;</span> =&gt; $provider-&gt;scope]);</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_variable" href="ajax_2knowbase_8php.html#a8d51972dab0856e7ed5db52b906de613">$_SESSION</a>[<span class="stringliteral">&#39;OAuth2.state&#39;</span>] = $provider-&gt;getState();</div>
<div class="line"> </div>
<div class="line">        header(<span class="stringliteral">&#39;Location: &#39;</span> . <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$authorizationUrl</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">exit</a>;</div>
<div class="line">    <span class="comment">// }</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> $token-&gt;getToken();</div>
<div class="line">}</div>
<div class="ttc" id="aajax_2knowbase_8php_html_a8d51972dab0856e7ed5db52b906de613"><div class="ttname"><a href="ajax_2knowbase_8php.html#a8d51972dab0856e7ed5db52b906de613">$_SESSION</a></div><div class="ttdeci">$_SESSION['kb_cat_id']</div><div class="ttdef"><b>Definition</b> knowbase.php:41</div></div>
<div class="ttc" id="aclass_the_networg_1_1_o_auth2_1_1_client_1_1_provider_1_1_azure_html"><div class="ttname"><a href="class_the_networg_1_1_o_auth2_1_1_client_1_1_provider_1_1_azure.html">TheNetworg\OAuth2\Client\Provider\Azure</a></div><div class="ttdef"><b>Definition</b> Azure.php:19</div></div>
<div class="ttc" id="acommon_8tabs_8php_html_a7b2772071c2b50e11742306f5abe68e3"><div class="ttname"><a href="common_8tabs_8php.html#a7b2772071c2b50e11742306f5abe68e3">$_GET</a></div><div class="ttdeci">if(!( $CFG_GLPI $_GET[&quot;use_public_faq&quot;] &amp;&amp;str_ends_with( $_GET[&quot;_target&quot;], '/front/helpdesk.faq.php'))) if(!isset($_GET['_glpi_tab']))['_glpi_tab']</div><div class="ttdef"><b>Definition</b> common.tabs.php:63</div></div>
<div class="ttc" id="areport_8contract_8php_html_a77b973d137fb33212e018b042df6e3e7"><div class="ttname"><a href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$y</a></div><div class="ttdeci">$y</div><div class="ttdef"><b>Definition</b> report.contract.php:71</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7428"></a>
Advanced flow</h3>
<p>The <a href="https://msdn.microsoft.com/en-us/library/azure/dn645542.aspx">Authorization Code Grant Flow</a> is a little bit different for Azure Active Directory. Instead of scopes, you specify the resource which you would like to access - there is a param <code>$provider-&gt;authWithResource</code> which will automatically populate the <code>resource</code> param of request with the value of either <code>$provider-&gt;resource</code> or <code>$provider-&gt;urlAPI</code>. This feature is mostly intended for v2.0 endpoint of Azure AD (see more <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/azure-ad-endpoint-comparison#scopes-not-resources">here</a>).</p>
<h3><a class="anchor" id="autotoc_md7429"></a>
Using custom parameters</h3>
<p>With <a href="https://github.com/thephpleague/oauth2-client">oauth2-client</a> of version 1.3.0 and higher, it is now possible to specify custom parameters for the authorization URL, so you can now make use of options like <code>prompt</code>, <code>login_hint</code> and similar. See the following example of obtaining an authorization URL which will force the user to reauthenticate: </p><div class="fragment"><div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$authUrl</a> = $provider-&gt;getAuthorizationUrl([</div>
<div class="line">    <span class="stringliteral">&#39;prompt&#39;</span> =&gt; <span class="stringliteral">&#39;login&#39;</span></div>
<div class="line">]);</div>
</div><!-- fragment --><p> You can find additional parameters <a href="https://msdn.microsoft.com/en-us/library/azure/dn645542.aspx">here</a>.</p>
<h2><a class="anchor" id="autotoc_md7430"></a>
Logging out</h2>
<p>If you need to quickly generate a logout URL for the user, you can do following: </p><div class="fragment"><div class="line"><span class="comment">// Assuming you have provider properly initialized.</span></div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$post_logout_redirect_uri</a> = <span class="stringliteral">&#39;https://www.msn.com&#39;</span>; <span class="comment">// The logout destination after the user is logged out from their account.</span></div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$logoutUrl</a> = $provider-&gt;getLogoutUrl(<a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$post_logout_redirect_uri</a>);</div>
<div class="line">header(<span class="stringliteral">&#39;Location: &#39;</span>.<a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$logoutUrl</a>); <span class="comment">// Redirect the user to the generated URL</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7431"></a>
Call on behalf of a token provided by another app</h3>
<div class="fragment"><div class="line"><span class="comment">// Use token provided by the other app</span></div>
<div class="line"><span class="comment">// Make sure the other app mentioned this app in the scope when requesting the token</span></div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$suppliedToken</a> = <span class="stringliteral">&#39;&#39;</span>;  </div>
<div class="line"> </div>
<div class="line">$provider = <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">xxxxx</a>;<span class="comment">// Initialize provider</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Call this to get claims</span></div>
<div class="line"><span class="comment">// $claims = $provider-&gt;validateAccessToken($suppliedToken);</span></div>
<div class="line"> </div>
<div class="line">$token = $provider-&gt;getAccessToken(<span class="stringliteral">&#39;jwt_bearer&#39;</span>, [</div>
<div class="line">    <span class="stringliteral">&#39;scope&#39;</span> =&gt; $provider-&gt;scope,</div>
<div class="line">    <span class="stringliteral">&#39;assertion&#39;</span> =&gt; <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$suppliedToken</a>,</div>
<div class="line">    <span class="stringliteral">&#39;requested_token_use&#39;</span> =&gt; <span class="stringliteral">&#39;on_behalf_of&#39;</span>,</div>
<div class="line">]);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7432"></a>
Making API Requests</h1>
<p>This library also provides easy interface to make it easier to interact with <a href="https://msdn.microsoft.com/en-us/library/azure/hh974476.aspx">Azure Graph API</a> and <a href="http://graph.microsoft.io">Microsoft Graph</a>, the following methods are available on <code>provider</code> object (it also handles automatic token refresh flow should it be needed during making the request):</p>
<ul>
<li><code>get($ref, $accessToken, $headers = [])</code></li>
<li><code>post($ref, $body, $accessToken, $headers = [])</code></li>
<li><code>put($ref, $body, $accessToken, $headers = [])</code></li>
<li><code>delete($ref, $body, $accessToken, $headers = [])</code></li>
<li><code>patch($ref, $body, $accessToken, $headers = [])</code></li>
<li><code>getObjects($tenant, $ref, $accessToken, $headers = [])</code> This is used for example for listing large amount of data - where you need to list all users for example - it automatically follows <code>odata.nextLink</code> until the end.<ul>
<li><code>$tenant</code> tenant has to be provided since the <code>odata.nextLink</code> doesn't contain it.</li>
</ul>
</li>
<li><code>request($method, $ref, $accessToken, $options = [])</code> See <a href="https://github.com/TheNetworg/oauth2-azure/issues/36">#36</a> for use case.</li>
</ul>
<p><em>Please note that if you need to create a custom request, the method getAuthenticatedRequest and getResponse can still be used.</em></p>
<h2><a class="anchor" id="autotoc_md7433"></a>
Variables</h2>
<ul>
<li><code>$ref</code> The URL reference without the leading <code>/</code>, for example <code>myOrganization/groups</code></li>
<li><code>$body</code> The contents of the request, make has to be either string (so make sure to use <code>json_encode</code> to encode the request)s or stream (see <a href="http://docs.guzzlephp.org/en/latest/request-options.html#body">Guzzle HTTP</a>)</li>
<li><code>$accessToken</code> The access token object obtained by using <code>getAccessToken</code> method</li>
<li><code>$headers</code> Ability to set custom headers for the request (see <a href="http://docs.guzzlephp.org/en/latest/request-options.html#headers">Guzzle HTTP</a>)</li>
</ul>
<h1><a class="anchor" id="autotoc_md7434"></a>
Resource Owner</h1>
<p>With version 1.1.0 and onward, the Resource Owner information is parsed from the JWT passed in <code>access_token</code> by Azure Active Directory. It exposes few attributes and one function.</p>
<p><b>Example:</b> </p><div class="fragment"><div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$resourceOwner</a> = $provider-&gt;getResourceOwner($token);</div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">echo</a> <span class="stringliteral">&#39;Hello, &#39;</span>.$resourceOwner-&gt;getFirstName().<span class="charliteral">&#39;!&#39;</span>;</div>
</div><!-- fragment --><p> The exposed attributes and function are:</p><ul>
<li><code>getId()</code> - Gets user's object id - unique for each user</li>
<li><code>getFirstName()</code> - Gets user's first name</li>
<li><code>getLastName()</code> - Gets user's family name/surname</li>
<li><code>getTenantId()</code> - Gets id of tenant which the user is member of</li>
<li><code>getUpn()</code> - Gets user's <a class="el" href="class_user.html">User</a> Principal Name, which can be also used as user's e-mail address</li>
<li><code>claim($name)</code> - Gets any other claim (specified as <code>$name</code>) from the JWT, full list can be found <a href="https://azure.microsoft.com/en-us/documentation/articles/active-directory-token-and-claims/">here</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md7435"></a>
Microsoft Graph</h1>
<p>Calling <a href="http://graph.microsoft.io/">Microsoft Graph</a> is very simple with this library. After provider initialization simply change the API URL followingly (replace <code>v1.0</code> with your desired version): </p><div class="fragment"><div class="line"><span class="comment">// Mention Microsoft Graph scope when initializing the provider </span></div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$baseGraphUri</a> = $provider-&gt;getRootMicrosoftGraphUri(<span class="keyword">null</span>);</div>
<div class="line">$provider-&gt;scope = <span class="stringliteral">&#39;your scope &#39;</span> . <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$baseGraphUri</a> . <span class="stringliteral">&#39;/User.Read&#39;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Call a query</span></div>
<div class="line">$provider-&gt;get($provider-&gt;getRootMicrosoftGraphUri($token) . <span class="stringliteral">&#39;/v1.0/me&#39;</span>, $token);</div>
</div><!-- fragment --><p> After that, when requesting access token, refresh token or so, provide the <code>resource</code> with value <code><a href="https://graph.microsoft.com/">https://graph.microsoft.com/</a></code> in order to be able to make calls to the Graph (see more about <code>resource</code> <a class="el" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">here</a>).</p>
<h1><a class="anchor" id="autotoc_md7436"></a>
Protecting your API - <em>experimental</em></h1>
<p>With version 1.2.0 you can now use this library to protect your API with Azure Active Directory authentication very easily. The Provider now also exposes <code>validateAccessToken(string $token)</code> which lets you pass an access token inside which you for example received in the <code>Authorization</code> header of the request on your API. You can use the function followingly (in vanilla PHP): </p><div class="fragment"><div class="line"><span class="comment">// Assuming you have already initialized the $provider</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Obtain the accessToken - in this case, we are getting it from Authorization header</span></div>
<div class="line"><a class="code hl_variable" href="locale_8php.html#a52500036ee807241b8b4b7e2367c49ef">$headers</a> = <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">getallheaders</a>();</div>
<div class="line"><span class="comment">// Assuming you got the value of Authorization header as &quot;Bearer [the_access_token]&quot; we parse it</span></div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$authorization</a> = explode(<span class="charliteral">&#39; &#39;</span>, <a class="code hl_variable" href="locale_8php.html#a52500036ee807241b8b4b7e2367c49ef">$headers</a>[<span class="stringliteral">&#39;Authorization&#39;</span>]);</div>
<div class="line">$accessToken = <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$authorization</a>[1];</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">    <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$claims</a> = $provider-&gt;validateAccessToken($accessToken);</div>
<div class="line">} <span class="keywordflow">catch</span> (Exception <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$e</a>) {</div>
<div class="line">    <span class="comment">// Something happened, handle the error</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// The access token is valid, you can now proceed with your code. You can also access the $claims as defined in JWT - for example roles, group memberships etc.</span></div>
<div class="ttc" id="alocale_8php_html_a52500036ee807241b8b4b7e2367c49ef"><div class="ttname"><a href="locale_8php.html#a52500036ee807241b8b4b7e2367c49ef">$headers</a></div><div class="ttdeci">$headers</div><div class="ttdef"><b>Definition</b> locale.php:110</div></div>
</div><!-- fragment --><p>You may also need to access some other resource from the API like the Microsoft Graph to get some additional information. In order to do that, there is <code>urn:ietf:params:oauth:grant-type:jwt-bearer</code> grant available (<a href="https://tools.ietf.org/html/draft-jones-oauth-jwt-bearer-03">RFC</a>). An example (assuming you have the code above working and you have the required permissions configured correctly in the Azure AD application): </p><div class="fragment"><div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$graphAccessToken</a> = $provider-&gt;getAccessToken(<span class="stringliteral">&#39;jwt_bearer&#39;</span>, [</div>
<div class="line">    <span class="stringliteral">&#39;resource&#39;</span> =&gt; <span class="stringliteral">&#39;https://graph.microsoft.com/v1.0/&#39;</span>,</div>
<div class="line">    <span class="stringliteral">&#39;assertion&#39;</span> =&gt; $accessToken,</div>
<div class="line">    <span class="stringliteral">&#39;requested_token_use&#39;</span> =&gt; <span class="stringliteral">&#39;on_behalf_of&#39;</span></div>
<div class="line">]);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$me</a> = $provider-&gt;get(<span class="stringliteral">&#39;https://graph.microsoft.com/v1.0/me&#39;</span>, <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$graphAccessToken</a>);</div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">print_r</a>(<a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$me</a>);</div>
</div><!-- fragment --><p> Just to make it easier so you don't have to remember entire name for <code>grant_type</code> (<code>urn:ietf:params:oauth:grant-type:jwt-bearer</code>), you just use short <code>jwt_bearer</code> instead.</p>
<h1><a class="anchor" id="autotoc_md7437"></a>
Azure Active Directory B2C - <em>experimental</em></h1>
<p>You can also now very simply make use of <a href="https://azure.microsoft.com/en-us/documentation/articles/active-directory-b2c-reference-oauth-code/">Azure Active Directory B2C</a>. Before authentication, change the endpoints using <code>pathAuthorize</code>, <code>pathToken</code> and <code>scope</code> and additionally specify your <a href="https://azure.microsoft.com/en-gb/documentation/articles/active-directory-b2c-reference-policies/">login policy</a>. <b>Please note that the B2C support is still experimental and wasn't fully tested.</b> </p><div class="fragment"><div class="line">$provider-&gt;pathAuthorize = <span class="stringliteral">&quot;/oauth2/v2.0/authorize&quot;</span>;</div>
<div class="line">$provider-&gt;pathToken = <span class="stringliteral">&quot;/oauth2/v2.0/token&quot;</span>;</div>
<div class="line">$provider-&gt;scope = [<span class="stringliteral">&quot;idtoken&quot;</span>];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Specify custom policy in our authorization URL</span></div>
<div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$authUrl</a> = $provider-&gt;getAuthorizationUrl([</div>
<div class="line">    <span class="charliteral">&#39;p&#39;</span> =&gt; <span class="stringliteral">&#39;b2c_1_siup&#39;</span></div>
<div class="line">]);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7438"></a>
Multipurpose refresh tokens - <em>experimental</em></h1>
<p>In cause that you need to access multiple resources (like your API and Microsoft Graph), you can use multipurpose <a href="https://msdn.microsoft.com/en-us/library/azure/dn645538.aspx">refresh tokens</a>. Once obtaining a token for first resource, you can simply request another token for different resource like so: </p><div class="fragment"><div class="line"><a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$accessToken2</a> = $provider-&gt;getAccessToken(<span class="stringliteral">&#39;refresh_token&#39;</span>, [</div>
<div class="line">    <span class="stringliteral">&#39;refresh_token&#39;</span> =&gt; <a class="code hl_variable" href="report_8contract_8php.html#a77b973d137fb33212e018b042df6e3e7">$accessToken1</a>-&gt;getRefreshToken(),</div>
<div class="line">    <span class="stringliteral">&#39;resource&#39;</span> =&gt; <span class="stringliteral">&#39;http://urlOfYourSecondResource&#39;</span></div>
<div class="line">]);</div>
</div><!-- fragment --><p> At the moment, there is one issue: When you make a call to your API and the token has expired, it will have the value of <code>$provider-&gt;urlAPI</code> which is obviously wrong for <code>$accessToken2</code>. The solution is very simple - set the <code>$provider-&gt;urlAPI</code> to the resource which you want to call. This issue will be addressed in future release. <b>Please note that this is experimental and wasn't fully tested.</b></p>
<h1><a class="anchor" id="autotoc_md7439"></a>
Known users</h1>
<p>If you are using this library and would like to be listed here, please let us know!</p><ul>
<li><a href="https://github.com/thenetworg/dreamspark-sso">TheNetworg/DreamSpark-SSO</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md7440"></a>
Contributing</h1>
<p>We accept contributions via <a href="https://github.com/thenetworg/oauth2-azure">Pull Requests on Github</a>.</p>
<h1><a class="anchor" id="autotoc_md7441"></a>
Credits</h1>
<ul>
<li><a href="https://github.com/hajekj">Jan Hajek</a> (<a href="https://thenetw.org">TheNetw.org</a>)</li>
<li><a href="https://github.com/vibronet">Vittorio Bertocci</a> (Microsoft)<ul>
<li>Thanks for the splendid support while implementing #16</li>
</ul>
</li>
<li><a href="https://github.com/mcetkovsky">Martin Cetkovský</a> (<a href="https://www.cetkovsky.eu">cetkovsky.eu</a>]</li>
<li><a href="https://github.com/thenetworg/oauth2-azure/contributors">All Contributors</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md7442"></a>
Support</h1>
<p>If you find a bug or encounter any issue or have a problem/question with this library please create a <a href="https://github.com/TheNetworg/oauth2-azure/issues">new issue</a>.</p>
<h1><a class="anchor" id="autotoc_md7443"></a>
License</h1>
<p>The MIT License (MIT). Please see <a href="https://github.com/thenetworg/oauth2-azure/blob/master/LICENSE">License File</a> for more information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Généré par&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
